---
# roles/passgen/tasks/main.yml

##############################################
# Install dependencies
##############################################
- name: Install required packages
  apt:
    name:
      - python3
      - python3-venv
      - python3-pip
      - nginx
      - git
    state: present
    update_cache: true

##############################################
# Create application directory
##############################################
- name: Create app directory
  file:
    path: /opt/passgen
    state: directory
    owner: root
    group: root
    mode: '0755'

##############################################
# Clone your repository
##############################################
- name: Clone passgen repository
  git:
    repo: "https://github.com/borntoeatt/halloween-coding-session.git"
    dest: /opt/passgen
    version: main
    force: yes
  notify: Restart passgen

##############################################
# Create Python virtual environment
##############################################
- name: Create virtual environment
  command: python3 -m venv /opt/passgen/venv
  args:
    creates: /opt/passgen/venv

##############################################
# Install ONLY Flask (no requirements.txt needed)
##############################################
- name: Install Flask inside venv
  command: /opt/passgen/venv/bin/pip install flask
  register: flask_install
  changed_when: "'Successfully installed' in flask_install.stdout"
  notify: Restart passgen

##############################################
# Systemd service for Flask app
##############################################
- name: Install passgen systemd service
  copy:
    dest: /etc/systemd/system/passgen.service
    mode: '0644'
    content: |
      [Unit]
      Description=PassGen Flask Application
      After=network.target

      [Service]
      WorkingDirectory=/opt/passgen
      ExecStart=/opt/passgen/venv/bin/python3 /opt/passgen/app.py
      Restart=always
      User=root

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd

##############################################
# Enable & start service
##############################################
- name: Enable and start passgen service
  systemd:
    name: passgen
    enabled: true
    state: started

##############################################
# Nginx reverse proxy
##############################################
- name: Install nginx config
  copy:
    dest: /etc/nginx/sites-available/passgen
    mode: '0644'
    content: |
      server {
          listen 80;
          server_name _;

          location / {
              proxy_pass http://127.0.0.1:5000;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
          }
      }
  notify: Restart nginx

- name: Enable nginx site
  file:
    src: /etc/nginx/sites-available/passgen
    dest: /etc/nginx/sites-enabled/passgen
    state: link
  notify: Restart nginx

##############################################
# Remove default nginx site
##############################################
- name: Remove default nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: Restart nginx

